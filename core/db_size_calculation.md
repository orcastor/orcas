# 数据库大小估算报告

## 10万个对象的数据库大小估算

### 表结构分析

#### 1. obj 表（对象表）
每行字段大小：
- `id`: BIGINT (8 bytes)
- `pid`: BIGINT (8 bytes)
- `did`: BIGINT (8 bytes)
- `size`: BIGINT (8 bytes)
- `mtime`: BIGINT (8 bytes)
- `type`: TINYINT (1 byte)
- `name`: TEXT (平均约20字节，文件名)
- `ext`: TEXT (平均约10字节，扩展信息JSON)

**每行数据大小**: 8+8+8+8+8+1+20+10 = **71 bytes**
**SQLite行开销**: 约8-12 bytes
**实际每行**: 约 **80-85 bytes**

10万行: 100,000 × 85 = **8.5 MB**

#### 2. data 表（数据块表）
每行字段大小：
- `id`: BIGINT (8 bytes)
- `size`: BIGINT (8 bytes)
- `o_size`: BIGINT (8 bytes)
- `md5`: BIGINT (8 bytes)
- `pkg_id`: BIGINT (8 bytes)
- `pkg_off`: INTEGER (4 bytes)
- `h_crc32`: INTEGER (4 bytes)
- `crc32`: INTEGER (4 bytes)
- `cksum`: INTEGER (4 bytes)
- `kind`: SMALLINT (2 bytes)

**每行数据大小**: 8+8+8+8+8+4+4+4+4+2 = **58 bytes**
**SQLite行开销**: 约8-12 bytes
**实际每行**: 约 **65-70 bytes**

假设每个对象平均有1个数据块（文件），10万个对象对应10万个数据块：
10万行: 100,000 × 70 = **7.0 MB**

#### 3. 索引大小

##### 3.1 uk_pid_name 索引（obj表的唯一索引）
- `pid`: BIGINT (8 bytes)
- `name`: TEXT (平均20 bytes)
- 索引开销: 约7 bytes

**每个索引条目**: 8+20+7 = **35 bytes**
10万条: 100,000 × 35 = **3.5 MB**

##### 3.2 ix_ref 索引（data表的引用索引）
- `o_size`: BIGINT (8 bytes)
- `h_crc32`: INTEGER (4 bytes)
- `crc32`: INTEGER (4 bytes)
- `md5`: BIGINT (8 bytes)
- 索引开销: 约6 bytes

**每个索引条目**: 8+4+4+8+6 = **30 bytes**
10万条: 100,000 × 30 = **3.0 MB**

**索引总计**: 3.5 + 3.0 = **6.5 MB**

#### 4. SQLite 数据库开销
- 页头、元数据、空闲空间: 约 **1-2 MB**

### 总计估算

| 组件 | 大小 |
|------|------|
| obj 表 | 8.5 MB |
| data 表 | 7.0 MB |
| 索引 | 6.5 MB |
| 数据库开销 | 1.5 MB |
| **总计** | **约 23.5 MB** |

### 不同场景的估算

#### 场景1: 简单文件（无版本历史）
- 10万个文件对象
- 10万个数据块
- **数据库大小**: 约 **23.5 MB**

#### 场景2: 带版本历史的文件
假设每个文件平均有5个版本：
- 10万个文件对象
- 50万个版本对象
- 50万个数据块
- **数据库大小**: 约 **117.5 MB** (23.5 × 5)

#### 场景3: 混合场景（文件+目录）
假设：
- 8万个文件对象
- 2万个目录对象（无数据块）
- 8万个数据块
- **数据库大小**: 约 **20.5 MB**

### 影响因素

1. **文件名长度**: 如果文件名平均更长（如50字节），obj表会增加约3 MB
2. **版本数量**: 每个版本会增加约0.24 MB（对象+数据+索引）
3. **扩展信息**: 如果ext字段存储更多JSON数据，会增加空间
4. **SQLite页面大小**: 默认4KB，可能有一些空间浪费
5. **数据库碎片**: 删除操作后可能产生碎片，实际大小可能略大

### 实际建议

对于10万个对象：
- **最小场景**（简单文件）: **约 20-25 MB**
- **典型场景**（带版本）: **约 50-100 MB**
- **复杂场景**（多版本+长文件名）: **约 100-150 MB**

### 性能考虑

- SQLite可以很好地处理10万个对象的查询
- 索引可以保证快速查找
- 建议定期执行 `VACUUM` 来优化数据库大小和性能

